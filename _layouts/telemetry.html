<!DOCTYPE html>
<html>
  <head>
    {% include analytics.html %}
    <link rel="icon" type="image/png" href="/assets/favicon-32x32.png" sizes="32x32" />
    <title>{% if page.title %}{{ page.title }} – {% endif %}{{ site.name }} – {{ site.description }}</title>
    {% include meta.html %}
    <link rel="stylesheet" type="text/css" href="{{ site.baseurl }}/style.css?v={{ site.time | date: '%s' }}" />
    <link rel="alternate" type="application/rss+xml" title="{{ site.name }} - {{ site.description }}" href="{{ site.baseurl }}/feed.xml" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
      /* Dashboard Layout */
      .dashboard-page {
        padding-bottom: 40px;
      }

      .dashboard-header {
        margin-bottom: 30px;
        border-bottom: 2px solid #f5f5f3;
        padding-bottom: 20px;
      }

      .dashboard-header h1 {
        margin: 0 0 8px 0;
        font-size: 32px;
      }

      .last-updated {
        margin: 0;
        color: #999;
        font-size: 13px;
        font-weight: 500;
      }

      /* Grid Layouts */
      .dashboard-grid-1 {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .dashboard-grid-2 {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-bottom: 20px;
      }

      .dashboard-grid-3 {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-bottom: 20px;
      }

      @media (max-width: 1024px) {
        .dashboard-grid-3 {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (max-width: 768px) {
        .dashboard-grid-2,
        .dashboard-grid-3 {
          grid-template-columns: 1fr;
        }
      }

      /* Card Styles */
      .status-card,
      .image-card,
      .chart-card,
      .forecast-card {
        background: #ffffff;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        transition: all 0.3s ease;
      }

      .status-card:hover,
      .image-card:hover,
      .chart-card:hover,
      .forecast-card:hover {
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid #f0f0f0;
        background: linear-gradient(135deg, #ffffff 0%, #faf9f0 100%);
      }

      .card-header h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        color: #131314;
      }

      .image-updated {
        font-size: 12px;
        color: #999;
        font-weight: 400;
      }

      .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: #4CAF50;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
      }

      /* Status Card Content */
      .card-content {
        padding: 16px 20px;
      }

      .status-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #f5f5f3;
        font-size: 14px;
      }

      .status-item:last-child {
        border-bottom: none;
      }

      .status-item .label {
        color: #666;
        font-weight: 500;
      }

      .status-item .value {
        color: #131314;
        font-weight: 600;
        font-size: 15px;
      }

      .status-item .unit {
        color: #999;
        font-size: 12px;
        margin-left: 4px;
        font-weight: 400;
      }

      .refresh-indicator {
        height: 4px;
        background: linear-gradient(90deg, #d97757, #6b9ed4, #d97757);
        background-size: 200% 100%;
        border-radius: 2px;
        animation: shimmer 2s infinite;
        margin-top: 12px;
      }

      @keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
      }

      /* Image Container */
      .image-container {
        padding: 16px 20px;
        text-align: center;
      }

      .image-container img {
        max-width: 100%;
        height: auto;
        border-radius: 6px;
        display: inline-block;
      }

      /* Chart Styles */
      .chart-card {
        padding: 20px;
      }

      .date {
        font-size: 14px;
        color: #666;
      }

      .chart-container {
        height: 300px;
        width: 100%;
        margin-bottom: 30px;
        position: relative;
      }

      .line {
        fill: none;
        stroke-width: 2px;
      }

      .outside-temp {
        stroke: #FF6B35;
      }

      .sky-temp {
        stroke: #004E89;
      }

      .rain-bar {
        fill: #4299e1;
        opacity: 0.7;
      }

      .grid line {
        stroke: #e0e0e0;
        stroke-opacity: 0.7;
        shape-rendering: crispEdges;
      }

      .grid path {
        stroke-width: 0;
      }

      .axis text {
        font-size: 12px;
        fill: #666;
      }

      .axis path, .axis line {
        fill: none;
        stroke: #e0e0e0;
        shape-rendering: crispEdges;
      }

      .tooltip {
        position: absolute;
        padding: 8px;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid #ddd;
        border-radius: 4px;
        pointer-events: none;
        font-size: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .legend {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
      }

      .legend-item {
        display: flex;
        align-items: center;
        margin: 0;
      }

      .legend-color {
        width: 12px;
        height: 3px;
        margin-right: 5px;
      }

      .legend-rain {
        width: 12px;
        height: 12px;
        margin-right: 5px;
        background-color: #4299e1;
        opacity: 0.7;
      }

      .forecast-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        margin-top: 20px;
      }

      .forecast-item {
        background-color: #f5f5f5;
        border-radius: 6px;
        padding: 10px;
        text-align: center;
      }

      .forecast-hour {
        font-size: 14px;
        font-weight: 600;
      }

      .forecast-icon {
        margin: 8px 0;
      }

      .forecast-temp {
        font-size: 16px;
        font-weight: bold;
      }

      .forecast-rain {
        font-size: 12px;
        color: #4299e1;
        margin-top: 4px;
      }

      .minmax {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
        font-size: 12px;
        color: #666;
      }

      .forecast-card .image-container {
        padding: 0;
      }

      .forecast-card .image-container img {
        border-radius: 0;
        width: 100%;
        height: auto;
      }

      /* Schedule Grid Styles */
      .schedule-card {
        background: #ffffff;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        transition: all 0.3s ease;
      }

      .schedule-card:hover {
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
      }

      .schedule-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }

      .schedule-table thead {
        background: linear-gradient(135deg, #ffffff 0%, #faf9f0 100%);
        border-bottom: 1px solid #f0f0f0;
      }

      .schedule-table th {
        padding: 12px 16px;
        text-align: left;
        font-weight: 600;
        color: #131314;
        border-bottom: 1px solid #f0f0f0;
      }

      .schedule-table td {
        padding: 10px 16px;
        border-bottom: 1px solid #f5f5f3;
        color: #131314;
      }

      .schedule-table tbody tr:last-child td {
        border-bottom: none;
      }

      .schedule-table tbody tr:hover {
        background-color: #fafaf8;
      }

      .state-idle {
        background-color: #f0f0f0;
        padding: 2px 6px;
        border-radius: 3px;
        display: inline-block;
        font-size: 11px;
        font-weight: 500;
        color: #666;
      }

      .state-running {
        background-color: #c8e6c9;
        padding: 2px 6px;
        border-radius: 3px;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: 11px;
        font-weight: 500;
        color: #1b5e20;
      }

      .spinner {
        display: inline-block;
        width: 10px;
        height: 10px;
        border: 2px solid #1b5e20;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      .state-scheduled {
        background-color: #fff9c4;
        padding: 2px 6px;
        border-radius: 3px;
        display: inline-block;
        font-size: 11px;
        font-weight: 500;
        color: #f57f17;
      }

      .state-completed {
        background-color: #b2dfdb;
        padding: 2px 6px;
        border-radius: 3px;
        display: inline-block;
        font-size: 11px;
        font-weight: 500;
        color: #004d40;
      }

      .state-error {
        background-color: #ffcdd2;
        padding: 2px 6px;
        border-radius: 3px;
        display: inline-block;
        font-size: 11px;
        font-weight: 500;
        color: #b71c1c;
      }

      .state-aborted {
        background-color: #ffcdd2;
        padding: 2px 6px;
        border-radius: 3px;
        display: inline-block;
        font-size: 11px;
        font-weight: 500;
        color: #b71c1c;
      }

      /* Log Panel Styles */
      .log-panel {
        background: #ffffff;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        height: auto;
      }

      .log-panel:hover {
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
      }

      .log-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid #f0f0f0;
        background: linear-gradient(135deg, #ffffff 0%, #faf9f0 100%);
      }

      .log-header h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        color: #131314;
      }

      .live-indicator {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: #666;
      }

      .live-spinner {
        display: inline-block;
        width: 8px;
        height: 8px;
        border: 2px solid #4CAF50;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      .log-container {
        padding: 16px 20px;
        flex: 1;
      }

      .log-text {
        background-color: #f5f5f5;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 12px;
        height: 150px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        line-height: 1.4;
        color: #333;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .log-text::-webkit-scrollbar {
        width: 8px;
      }

      .log-text::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }

      .log-text::-webkit-scrollbar-thumb {
        background: #bbb;
        border-radius: 4px;
      }

      .log-text::-webkit-scrollbar-thumb:hover {
        background: #888;
      }
    </style>
    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->
  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="{{ site.baseurl }}/" class="site-avatar"><img src="{{ site.avatar }}" /></a>

          <div class="site-info">
            <h1 class="site-name"><a href="{{ site.baseurl }}/">{{ site.name }}</a></h1>
            <p class="site-description">{{ site.description }}</p>
          </div>

          <nav>
            <a href="{{ site.baseurl }}/">Blog</a>
            <a href="{{ site.baseurl }}/photos">Photos</a>
            <a href="{{ site.baseurl }}/about">About</a>
            <a href="{{ site.baseurl }}/data">Data</a>
            <a href="{{ site.baseurl }}/telemetry">Telemetry</a>
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <article class="page dashboard-page">

        <div class="dashboard-header">
          <h1>{{ page.title }}</h1>
          <p class="last-updated">Last updated: <span id="last-update">--:--</span></p>
        </div>

        <!-- Status Cards Row -->
        <div class="dashboard-grid-3">
          <!-- Weather Card -->
          <div class="status-card weather-card">
            <div class="card-header">
              <h3>Weather</h3>
              <div class="status-indicator" id="weather-status"></div>
            </div>
            <div class="card-content">
              <div class="status-item">
                <span class="label">Rain</span>
                <span class="value" id="rain">--</span>
              </div>
              <div class="status-item">
                <span class="label">Sky Temp</span>
                <span class="value" id="skytemp">--</span>
                <span class="unit">°C</span>
              </div>
              <div class="status-item">
                <span class="label">Ambient Temp</span>
                <span class="value" id="ambienttemp">--</span>
                <span class="unit">°C</span>
              </div>
              <div class="status-item">
                <span class="label">Darkness (SQM)</span>
                <span class="value" id="sqm">--</span>
              </div>
            </div>
          </div>

          <!-- Observatory Card -->
          <div class="status-card observatory-card">
            <div class="card-header">
              <h3>Observatory</h3>
              <div class="status-indicator" id="roof-status"></div>
            </div>
            <div class="card-content">
              <div class="status-item">
                <span class="label">Roof</span>
                <span class="value" id="roof">--</span>
              </div>
              <div class="status-item">
                <span class="label">Main Computer</span>
                <span class="value" id="maincomputer">--</span>
              </div>
              <div class="status-item">
                <span class="label">Mount</span>
                <span class="value" id="mount">--</span>
              </div>
              <div class="status-item">
                <span class="label">CCD Camera</span>
                <span class="value" id="ccdcamera">--</span>
              </div>
              <div class="status-item">
                <span class="label">Telescope</span>
                <span class="value" id="radec">--</span>
              </div>
            </div>
          </div>

          <!-- Security Camera -->
          <div class="image-card">
            <div class="card-header">
              <h3>Security Camera (CAM1)</h3>
              <span class="image-updated">Live</span>
            </div>
            <div class="image-container">
              <img id="obscam" src="https://52-8.xyz/images/telemetry/snapshot-obs1.jpg" alt="Observatory security camera">
            </div>
          </div>
        </div>


        <!-- Schedule Grid Row -->
        <div class="dashboard-grid-1">
          <div class="schedule-card">
            <div class="card-header">
              <h3>Tonight's Schedule</h3>
              <span class="image-updated">Observable targets</span>
            </div>
            <div style="padding: 16px 20px; overflow-x: auto;">
              <table class="schedule-table" id="schedule-table">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>State</th>
                    <th>Completed</th>
                    <th>Altitude</th>
                    <th>Startup</th>
                    <th>End</th>
                  </tr>
                </thead>
                <tbody id="schedule-body">
                  <tr>
                    <td colspan="6" style="text-align: center; color: #999;">Loading schedule...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Scheduler Log Panel -->
        <div class="dashboard-grid-1">
          <div class="log-panel">
            <div class="log-header">
              <h3>Scheduler Log</h3>
              <div class="live-indicator">
                <div class="live-spinner" id="log-spinner"></div>
                <span>Live</span>
              </div>
            </div>
            <div class="log-container">
              <div class="log-text" id="log-text">Loading log...</div>
            </div>
          </div>
        </div>

        <!-- Recent Image Row -->
        <div class="dashboard-grid-1">
          <div class="image-card">
            <div class="card-header">
              <h3>Most Recent Image</h3>
              <span class="image-updated">Raw uncalibrated</span>
            </div>
            <div class="image-container">
              <img id="latestfits" src="https://52-8.xyz/images/latest-fits.jpg" alt="Latest FITS image">
            </div>
          </div>
        </div>

        <!-- Weather Chart -->
        <div class="dashboard-grid-1">
          <div class="chart-card">
            <div class="card-header">
              <h3>Weather Monitoring</h3>
              <span class="image-updated">Previous 24 hours</span>
            </div>
            <div class="chart-container" id="chart"></div>

            <div class="legend">
              <div class="legend-item">
                <div class="legend-color" style="background-color: #FF6B35;"></div>
                <span>Ambient Temperature</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background-color: #004E89;"></div>
                <span>Sky Temperature</span>
              </div>
              <div class="legend-item">
                <div class="legend-rain"></div>
                <span>Rain</span>
              </div>
            </div>

            <div class="forecast-grid" id="forecast"></div>

            <div class="minmax" id="minmax"></div>
          </div>
        </div>

        <!-- Forecasts Row -->
        <div class="dashboard-grid-2">
          <!-- YR.NO Forecast -->
          <div class="forecast-card">
            <div class="card-header">
              <h3>Weather Forecast</h3>
              <span class="image-updated">yr.no</span>
            </div>
            <div class="image-container">
              <img src="https://www.yr.no/en/content/2-2962587/meteogram.svg" alt="YR.NO Weather Forecast">
            </div>
          </div>

          <!-- Clear Outside Forecast -->
          <div class="forecast-card">
            <div class="card-header">
              <h3>Observing Forecast</h3>
              <span class="image-updated">Clear Outside</span>
            </div>
            <div class="image-container">
              <img src="https://clearoutside.com/forecast_image_medium/52.27/-8.27/forecast.png" alt="Clear Outside Forecast">
            </div>
          </div>
        </div>

        <!-- Sunset/Twilight Row -->
        <div class="dashboard-grid-1">
          <div class="forecast-card">
            <div class="card-header">
              <h3>Sunset & Twilight Times</h3>
              <span class="image-updated">Annual chart</span>
            </div>
            <div class="image-container">
              <img src="https://clearoutside.com/annual_darkness_image/52.2/-8.40/annual_darkness.png" alt="Sunset and twilight times">
            </div>
          </div>
        </div>

        <div class="entry">
          {{ content }}
        </div>
      </article>
    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          {% include svg-icons.html %}
        </footer>
      </div>
    </div>
    {% include analytics.html %}
    <script>
      function update_telemetry() {
        $.getJSON('https://52-8.xyz/images/telemetry/current-weather.json?'+new Date().getTime(), function(telemetry) {
                  $( "#skytemp" ).html( telemetry.skyTemp )
                  $( "#ambienttemp" ).html( telemetry.outsideTemp  )
                  $( "#rain" ).html( telemetry.rain ? 'Raining' : 'Not Raining')
               });
      }
      function update_roof() {
        $.getJSON('https://52-8.xyz/images/telemetry/roof.json?'+new Date().getTime(), function(roof) {
                  $("#roof").html(roof.state + ' since ' + roof.last_changed);
               });
      }
      function update_pc_state() {
        $.getJSON('https://52-8.xyz/images/telemetry/pc_state.json?'+new Date().getTime(), function(pc) {
                  if (pc.online) {
                    const uptimeHours = (pc.uptime_seconds / 3600).toFixed(1);
                    const load1min = pc.load_average['1min'].toFixed(2);
                    const load5min = pc.load_average['5min'].toFixed(2);
                    const load15min = pc.load_average['15min'].toFixed(2);
                    const html = "ONLINE (" + uptimeHours + "h)<br/><span style='font-size: 12px; color: #999;'>Load: " + load1min + " / " + load5min + " / " + load15min + "</span>";
                    $("#maincomputer").html(html);
                  } else {
                    $("#maincomputer").html("OFFLINE");
                  }
               });
      }
      function update_indi_props() {
        $.getJSON('https://52-8.xyz/images/telemetry/indi_properties.json?'+new Date().getTime(), function(indi) {
                  $("#mount").html(indi.iOptronV3.CONNECTION.CONNECT ? "CONNECTED" : "OFFLINE");
                  $("#ccdcamera").html(indi["Atik 383L"].CONNECTION.CONNECT ? "CONNECTED" : "OFFLINE");
                  $("#radec").html(indi.iOptronV3.TELESCOPE_PARK.UNPARK ? "TRACKING" : "PARKED");
                  $("#sqm").html(parseFloat(indi.SQM.SKY_QUALITY.SKY_BRIGHTNESS).toFixed(1));
               });
      }

      function getStateClass(state) {
        // Map state numbers to classes
        // FIXME: 5 might be state-aborted, not sure
        switch(state) {
          case 0: return 'state-idle';
          case 2: return 'state-scheduled';
          case 3: return 'state-running';
          case 5: return 'state-aborted';
          case 7: return 'state-completed';
          default: return 'state-error';
        }
      }

      function getStateName(state) {
        switch(state) {
          case 0: return 'Idle';
          case 2: return 'Scheduled';
          case 3: return 'Running';
          case 5: return 'Aborted';
          case 7: return 'Completed';
          default: return 'Error';
        }
      }

      function update_schedule() {
        $.getJSON('https://52-8.xyz/images/telemetry/ekos.json?'+new Date().getTime(), function(schedule) {
          let html = '';
          schedule.forEach(function(item) {
            let stateHtml = '<span class="' + getStateClass(item.state) + '">';
            if (item.state === 3 || item.state === 5) {
              stateHtml += '<span class="spinner"></span>';
            }
            stateHtml += getStateName(item.state) + '</span>';

            html += '<tr>';
            html += '<td>' + item.name + '</td>';
            html += '<td>' + stateHtml + '</td>';
            html += '<td>' + item.completedCount + '/' + item.sequenceCount + '</td>';
            html += '<td>' + item.altitudeFormatted + '</td>';
            html += '<td>' + item.startupFormatted + '</td>';
            html += '<td>' + item.endFormatted + '</td>';
            html += '</tr>';
          });
          $("#schedule-body").html(html);
        });
      }

      function update_last_updated() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        $("#last-update").text(hours + ':' + minutes);
      }

      function update_scheduler_log() {
        $.ajax({
          url: 'https://52-8.xyz/images/telemetry/ekos_log.txt?' + new Date().getTime(),
          type: 'GET',
          dataType: 'text',
          success: function(data) {
            $("#log-text").text(data);
            // Auto-scroll to top to show newest entries
            let logElement = document.getElementById('log-text');
            logElement.scrollTop = 0;
          },
          error: function() {
            $("#log-text").text('Unable to load scheduler log');
          }
        });
      }

      function poll_for_updates() {
        $("#obscam").attr("src", "https://52-8.xyz/images/telemetry/snapshot-obs1.jpg?"+new Date().getTime());
        $("#screenshot").attr("src", "https://52-8.xyz/images/telemetry/screenshot.png?"+new Date().getTime());
        $("#latestfits").attr("src", "https://52-8.xyz/images/latest-fits.jpg?"+new Date().getTime());
        update_telemetry();
        update_roof();
        update_pc_state();
        update_indi_props();
        update_schedule();
        update_scheduler_log();
        update_last_updated();
        setTimeout("poll_for_updates()", 60000);
      }

      $( document ).ready(function() {
        update_last_updated();
        update_scheduler_log();
        poll_for_updates()
      });
    </script>
    <script src="dash.js"></script>
  </body>
</html>
